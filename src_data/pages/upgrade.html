<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n>upgrade.title</title>
    <link rel="stylesheet" href="/static/app.css?{BUILD_TIME}">
  </head>

  <body>
    <header class="container">
      <nav>
        <ul>
          <li>
            <a href="/">
              <div class="logo" data-i18n>logo</div>
            </a>
          </li>
        </ul>
        <ul>
          <li>
            <select id="lang" aria-label="Lang">
              <option value="en" selected>EN</option>
              <option value="cn">CN</option>
              <option value="it">IT</option>
              <option value="nl">NL</option>
              <option value="ru">RU</option>
            </select>
          </li>
        </ul>
      </nav>
    </header>

    <main class="container">
      <article>
        <div>
          <hgroup>
            <h2 data-i18n>upgrade.section.backupAndRestore</h2>
            <p data-i18n>upgrade.section.backupAndRestore.desc</p>
          </hgroup>

          <form action="/api/backup/restore" id="restore">
            <label for="restore-file">
              <span data-i18n>upgrade.settingsFile</span>
              <input type="file" name="settings" id="restore-file" accept=".json">
            </label>

            <div role="group">
              <button type="submit" data-i18n>button.restore</button>
              <button type="button" class="secondary" onclick="window.location='/api/backup/save';" data-i18n>button.backup</button>
            </div>
          </form>
        </div>
      </article>

      <!-- ============== 新增恢复出厂设置 (Factory Reset) ============== -->
      <article>
        <div>
          <hgroup>
            <h2 data-i18n>upgrade.section.factoryReset</h2>
            <p data-i18n>upgrade.section.factoryReset.desc</p>
          </hgroup>
          <p><mark data-i18n>upgrade.note.factoryResetWarning</mark></p>
          <button id="factory-reset-btn" class="secondary" data-i18n>button.factoryReset</button>
        </div>
      </article>
      <!-- ========================== END: 恢复出厂设置 ========================== -->
       <!-- ====================== 增加OTA ====================== -->
      <article>
        <div>
          <hgroup>
            <h2 data-i18n>upgrade.section.ota</h2>
            <p data-i18n>upgrade.section.ota.desc</p>
          </hgroup>
          <div class="grid">
            <div><span data-i18n>upgrade.section.currentVersion</span>: <strong id="current-version">Loading...</strong></div>
            <div><span data-i18n>upgrade.section.latestVersion</span>: <strong id="latest-version">N/A</strong></div>
          </div>
          <p id="update-status" class="hidden" style="margin-top: 1rem;"></p>
          <div role="group">
            <button id="check-update-btn" data-i18n>button.checkForUpdates</button>
            <button id="perform-update-btn" class="contrast hidden" data-i18n>button.updateNow</button>
          </div>
        </div>
      </article>
      <!-- ====================== END: OTA ====================== -->
      <article>
        <div>
          <hgroup>
            <h2 data-i18n>upgrade.section.upgrade</h2>
            <p data-i18n>upgrade.section.upgrade.desc</p>
          </hgroup>

          <form action="/api/upgrade" id="upgrade">
            <fieldset class="primary">
              <label for="firmware-file">
                <span data-i18n>upgrade.fw</span>:
                <div class="grid">
                  <input type="file" name="firmware" id="firmware-file" accept=".bin">
                  <button type="button" class="upgrade-firmware-result hidden" disabled></button>
                </div>
              </label>

              <label for="filesystem-file">
                <span data-i18n>upgrade.fs</span>:
                <div class="grid">
                  <input type="file" name="filesystem" id="filesystem-file" accept=".bin">
                  <button type="button" class="upgrade-filesystem-result hidden" disabled></button>
                </div>
              </label>
            </fieldset>

            <ul>
              <li><mark data-i18n>upgrade.note.disclaimer1</mark></li>
              <li><mark data-i18n>upgrade.note.disclaimer2</mark></li>
            </ul>

            <button type="submit" data-i18n>button.upgrade</button>
          </form>
        </div>
      </article>
    </main>

    <footer class="container">
      <small>
        <b>Made by Laxilef</b>
        • <a href="https://github.com/Laxilef/OTGateway/blob/master/LICENSE" target="_blank" class="secondary" data-i18n>nav.license</a>
        • <a href="https://github.com/Laxilef/OTGateway/blob/master/" target="_blank" class="secondary" data-i18n>nav.source</a>
        • <a href="https://github.com/Laxilef/OTGateway/wiki" target="_blank" class="secondary" data-i18n>nav.help</a>
        • <a href="https://github.com/Laxilef/OTGateway/issues" target="_blank" class="secondary" data-i18n>nav.issues</a>
        • <a href="https://github.com/Laxilef/OTGateway/releases" target="_blank" class="secondary" data-i18n>nav.releases</a>
      </small>
    </footer>

    <script src="/static/app.js?{BUILD_TIME}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const lang = new Lang(document.getElementById('lang'));
        lang.build();

        setupRestoreBackupForm('#restore');
        setupUpgradeForm('#upgrade');
        //增加相关函数
        setupOnlineUpdate();
        setupFactoryReset();
      });
      
      // ==== OTA 函数 ====
      function setupOnlineUpdate() {
      const ui = {
    checkBtn: document.getElementById('check-update-btn'),
    updateBtn: document.getElementById('perform-update-btn'),
    statusEl: document.getElementById('update-status'),
    currentVersionEl: document.getElementById('current-version'),
    latestVersionEl: document.getElementById('latest-version'),
  };

  let state = {
    firmwareUrl: '',
    devicePlatform: '',
    currentVersion: '',
  };

  const setStatus = (message, isBusy = false) => {
    ui.statusEl.innerHTML = message;
    ui.statusEl.classList.remove('hidden');
    ui.checkBtn.setAttribute('aria-busy', String(isBusy));
  };

  const showUpdateAvailable = (release) => {
    setStatus(`New version available: <strong>${release.tag_name}</strong>. <a href="${release.html_url}" target="_blank">View Notes</a>`);
    ui.updateBtn.classList.remove('hidden');
  };
  
  const hideUpdateControls = () => {
    ui.updateBtn.classList.add('hidden');
  };

  const fetchDeviceInfo = async () => {
    try {
      const response = await fetch('/api/version');
      if (!response.ok) throw new Error('Failed to fetch device info');
      const data = await response.json();
      state.currentVersion = data.version || 'Unknown';
      state.devicePlatform = data.platform || '';
      ui.currentVersionEl.textContent = state.currentVersion;
      if (!state.devicePlatform) {
        setStatus('Error: Device platform unknown.');
      }
    } catch (error) {
      console.error(error);
      ui.currentVersionEl.textContent = 'Error';
      setStatus('Could not retrieve device info.');
    }
  };

  ui.checkBtn.addEventListener('click', async () => {
    hideUpdateControls();
    setStatus('Checking for updates...', true);
    ui.latestVersionEl.textContent = 'N/A';
    
    if (!state.devicePlatform) {
      setStatus('Cannot check: device platform is unknown.');
      return;
    }

    try {
      const response = await fetch('https://api.github.com/repos/heyggu/OTGateway/releases/latest');
      if (!response.ok) throw new Error('GitHub API fetch failed');
      const latestRelease = await response.json();
      ui.latestVersionEl.textContent = latestRelease.tag_name;

      if (latestRelease.tag_name === state.currentVersion) {
        setStatus('You are using the latest version.');
        return;
      }
      
      const firmwareAsset = latestRelease.assets.find(asset => {
        const name = asset.name.toLowerCase();
        return name.includes(state.devicePlatform.toLowerCase()) && name.includes('firmware') && !name.includes('fs') && !name.includes('factory');
      });

      if (firmwareAsset) {
        state.firmwareUrl = firmwareAsset.browser_download_url;
        showUpdateAvailable(latestRelease);
      } else {
        setStatus(`New version found, but a firmware for your device (${state.devicePlatform}) was not located.`);
      }
    } catch (error) {
      console.error(error);
      setStatus('Error checking for updates.');
    } finally {
      ui.checkBtn.setAttribute('aria-busy', 'false');
    }
  });

  ui.updateBtn.addEventListener('click', async () => {
    if (!state.firmwareUrl) { alert('Firmware download URL is missing.'); return; }
    if (!confirm(`Are you sure you want to upgrade? The device will restart.`)) { return; }
    
    ui.updateBtn.setAttribute('aria-busy', 'true');
    ui.updateBtn.disabled = true;
    ui.checkBtn.disabled = true;
    setStatus('Update in progress... Please do not power off the device.');

    try {
      const response = await fetch('/api/ota_upgrade', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: state.firmwareUrl }) });
      if (!response.ok) {
        const errorData = await response.text();
        throw new Error(errorData || 'Update failed on the device.');
      }
      setStatus('Update started successfully! The device is now rebooting.');
    } catch (error) {
      console.error(error);
      setStatus(`An error occurred: ${error.message}`);
      ui.updateBtn.setAttribute('aria-busy', 'false');
      ui.updateBtn.disabled = false;
      ui.checkBtn.disabled = false;
    }
  });

  fetchDeviceInfo();
      }

      // ============ 恢复出厂设置 函数 =============
      function setupFactoryReset() {
        const resetBtn = document.getElementById('factory-reset-btn');
        if (!resetBtn) return;

        resetBtn.addEventListener('click', async () => {
          if (!confirm("WARNING: This will erase all your settings, including Wi-Fi credentials. The device will restart. Are you absolutely sure?")) {
            return;
          }
          if (!confirm("FINAL CONFIRMATION: Proceed with factory reset?")) {
            return;
          }

          resetBtn.setAttribute('aria-busy', 'true');
          resetBtn.disabled = true;
          resetBtn.textContent = 'Resetting...';

          try {
            const response = await fetch('/api/factory/reset', { method: 'POST' });
            if (response.ok) {
              alert('Factory reset initiated. The device will now reboot.');
            } else {
              throw new Error('Failed to initiate factory reset on the device.');
            }
          } catch (error) {
            console.error(error);
            alert(`An error occurred: ${error.message}`);
            resetBtn.setAttribute('aria-busy', 'false');
            resetBtn.disabled = false;
            resetBtn.textContent = 'Factory Reset';
          }
        });
      }
    </script>
  </body>
</html>
